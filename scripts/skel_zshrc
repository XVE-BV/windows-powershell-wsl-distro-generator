#!/bin/zsh

# /etc/skel/.zshrc

# add ~/bin to PATH if it exists
if [ -d "$HOME/bin" ] && [[ ":$PATH:" != *":$HOME/bin:"* ]]; then
  PATH="$HOME/bin:$PATH"
fi

# Jump straight into /apps on interactive shells
if [[ -o interactive && $(id -u) -ne 0 ]]; then
cd /apps
fi

# Show XVE logo in green
GREEN=$'\e[32m'
RESET=$'\e[0m'

# Show XVE logo in green, preserving alignment
printf '%b\n' "${GREEN}____  _______   _______________${RESET}"
printf '%b\n' "${GREEN}\   \/  /\   \ /   /\_   _____/${RESET}"
printf '%b\n' "${GREEN} \     /  \   Y   /  |    __)_ ${RESET}"
printf '%b\n' "${GREEN} /     \   \     /   |        \\\\${RESET}"
printf '%b\n' "${GREEN}/___/\  \   \___/   /_______  /${RESET}"
printf '%b\n' "${GREEN}      \_/                   \/ ${RESET}"
echo


# Make nano the default editor
export VISUAL=nano
export EDITOR="$VISUAL"

# Laravel Sail function and shortcuts
sail() {
  if [[ -f ./vendor/bin/sail ]]; then
    zsh ./vendor/bin/sail "$@"
  else
    echo "vendor/bin/sail not found"
  fi
}
alias s='sail '
alias sa='sail artisan '
alias sc='sail composer '
alias sm='sa migrate'
alias smf='sa migrate:fresh'
alias smfs='sa migrate:fresh --seed'
alias sus='s up -d'
alias sdown='s stop'

# Powerlevel10k instant prompt (if installed)
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

source /opt/powerlevel10k/powerlevel10k.zsh-theme
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh

# 1) Auto-symlink Windows SSH folder if none exists
if [[ -o interactive && ! -e $HOME/.ssh ]]; then
  # 1) Ask Windows what %USERPROFILE% is, strip CR/LF
  winprof=$(cmd.exe /C 'echo %USERPROFILE%' 2>/dev/null | tr -d '\r\n')
  # 2) Convert to a WSL path
  wslwin=$(wslpath "$winprof" 2>/dev/null)
  win_ssh="$wslwin/.ssh"

  if [[ -d $win_ssh ]]; then
    echo "🔗 Linking WSL ~/.ssh → $win_ssh"
    ln -s "$win_ssh" "$HOME/.ssh"
  else
    echo "⚠️  Windows SSH folder not found at $win_ssh"
  fi
fi

# 2) Start ssh-agent if needed and load keys
if [[ -o interactive && -z $SSH_AUTH_SOCK ]]; then
  eval "$(ssh-agent -s)" >/dev/null

  # only attempt to load if there are id_* files
  if ls "$HOME/.ssh"/id_* 1>/dev/null 2>&1; then
    for key in "$HOME/.ssh"/id_*; do
      [[ $key == *.pub ]] && continue
      ssh-add "$key" >/dev/null 2>&1
    done
  fi
fi